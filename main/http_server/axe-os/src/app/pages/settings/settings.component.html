<!-- update.component.html -->


  <!-- Settings Card (stays separate) -->
  <nb-card>
    <nb-card-header>{{ 'SETTINGS.TITLE' | translate }}</nb-card-header>
    <nb-card-body>
      <app-edit></app-edit>
    </nb-card-body>
  </nb-card>

  <!-- Language Settings Card -->
  <nb-card>
    <nb-card-header>{{ 'LANGUAGE.TITLE' | translate }}</nb-card-header>
    <nb-card-body>
      <app-language-selector></app-language-selector>
    </nb-card-body>
  </nb-card>

  <!-- Flex container for the update cards -->
  <div class="cards-container">

    <!-- Enhanced Version Info Card with Status Badge -->
    <nb-card class="card-item version-card">
      <nb-card-header>
        <div class="version-header">
          <span>{{ 'UPDATE.VERSION_INFO' | translate }}</span>
          <nb-badge [status]="getStatusBadgeColor()" [text]="getStatusTranslationKey() | translate" position="top right"></nb-badge>
        </div>
      </nb-card-header>
      <nb-card-body>
        <div class="version-info">
          <div class="version-row">
            <strong>{{ 'UPDATE.CURRENT_VERSION' | translate }}:</strong>
            <span>{{ currentVersion }}</span>
          </div>
          <ng-container *ngIf="latestRelease$ | async as latestRelease">
            <div class="version-row">
              <strong>{{ 'UPDATE.LATEST_RELEASE' | translate }}:</strong>
              <span>{{ latestRelease.tag_name }}</span>
            </div>
            <div class="version-row">
              <strong>{{ 'UPDATE.PUBLISHED' | translate }}:</strong>
              <span>{{ latestRelease.published_at | date }}</span>
            </div>

            <!-- Changelog Toggle -->
            <div class="changelog-section">
              <button nbButton ghost size="small" (click)="toggleChangelog()">
                <nb-icon [icon]="showChangelog ? 'chevron-up-outline' : 'chevron-down-outline'" pack="eva"></nb-icon>
                {{ showChangelog ? ('UPDATE.HIDE_CHANGELOG' | translate) : ('UPDATE.SHOW_CHANGELOG' | translate) }}
              </button>
              <div *ngIf="showChangelog" class="changelog-content" [innerHTML]="changelog"></div>
            </div>
          </ng-container>
        </div>
      </nb-card-body>
    </nb-card>

    <nb-card class="card-item" style="position: relative;">
      <nb-card-header>
        {{ 'UPDATE.UPDATE_ONE_CLICK' | translate }}
      </nb-card-header>
      <nb-card-body>
        <!-- Direct Update from GitHub -->
        <div class="update-section">
          <h6>{{ 'UPDATE.DIRECT_FROM_GITHUB' | translate }}</h6>
          <button nbButton
                  [status]="updateStatus === UpdateStatus.UPDATE_AVAILABLE ? 'warning' : 'primary'"
                  size="small"
                  [nbSpinner]="isOneClickUpdate"
                  [disabled]="isOneClickUpdate || !latestRelease"
                  (click)="directUpdateFromGithub()">
            <nb-icon icon="cloud-download-outline" pack="eva"></nb-icon>&nbsp;
            {{ 'UPDATE.INSTALL_FROM_GITHUB' | translate }}
          </button>

          <div class="progress-wrapper" *ngIf="isOneClickUpdate">
            <nb-progress-bar
              [value]="otaProgress"
              [status]="otaProgress >= 100 ? 'success' : 'info'"
              [displayValue]="false"
              size="large">
            </nb-progress-bar>

            <!-- centered label on top of the bar -->
            <div class="progress-label">
              <ng-container *ngIf="otaProgress === 0">
                {{ 'UPDATE.INITIALIZING' | translate }}
              </ng-container>
              <ng-container *ngIf="otaProgress > 0 && otaProgress < 100">
                {{ (currentStep || 'STEP_UNKNOWN') | translate }}: {{ otaProgress }}%
              </ng-container>
              <ng-container *ngIf="otaProgress >= 100">
                {{ 'UPDATE.INSTALLATION_COMPLETE' | translate }}
              </ng-container>
            </div>
          </div>
        </div>

        <hr>

      </nb-card-body>
    </nb-card>

    <nb-card class="card-item" style="position: relative;">
      <nb-card-header>
        {{ 'UPDATE.LEGACY' | translate }}
      </nb-card-header>
      <nb-card-body>
        <!-- Manual File Upload -->
        <div class="update-section">
          <h6>{{ 'UPDATE.MANUAL_FIRMWARE_UPDATE' | translate }}</h6>
          <input type="file"
                 #firmwareInput
                 hidden
                 (change)="onFirmwareFileSelected($event)"
                 accept=".bin">
          <div class="action-buttons">
            <button nbButton [status]="'basic'" size="small" (click)="firmwareInput.click()">
              <nb-icon icon="folder-outline" pack="eva"></nb-icon>&nbsp;
              {{ 'UPDATE.BROWSE' | translate }}
            </button>
            <button nbButton [status]="'primary'" size="small" [nbSpinner]="isFirmwareUploading" (click)="uploadFirmwareFile()">
              <nb-icon icon="upload-outline" pack="eva"></nb-icon>&nbsp;
              {{ 'UPDATE.FLASH' | translate }}
            </button>
          </div>
          <small>({{ expectedFileName }})</small>
        </div>

        <hr>

        <!-- Manual File Upload -->
        <div class="update-section">
          <h6>{{ 'UPDATE.MANUAL_WWW_UPDATE' | translate }}</h6>
          <input type="file"
                 #websiteInput
                 hidden
                 (change)="onWebsiteFileSelected($event)"
                 accept=".bin">
          <div class="action-buttons">
            <button nbButton [status]="'basic'" size="small" (click)="websiteInput.click()">
              <nb-icon icon="folder-outline" pack="eva"></nb-icon>&nbsp;
              {{ 'UPDATE.BROWSE' | translate }}
            </button>
            <button nbButton [status]="'primary'" size="small" [nbSpinner]="isWebsiteUploading" (click)="uploadWebsiteFile()">
              <nb-icon icon="upload-outline" pack="eva"></nb-icon>&nbsp;
              {{ 'UPDATE.FLASH' | translate }}
            </button>
          </div>
          <small>(www.bin)</small>
        </div>
      </nb-card-body>
    </nb-card>
  </div>
