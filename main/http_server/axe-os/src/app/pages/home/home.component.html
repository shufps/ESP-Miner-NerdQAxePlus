<ng-template #loading>
  <h4>{{ 'COMMON.LOADING' | translate }}</h4>
</ng-template>

<ng-template #shutdown>
  <h4>{{ 'COMMON.SHUTDOWN' | translate }}</h4>
</ng-template>

<div>
  <div *ngIf="info$ | async as info; else loading">
    <div *ngIf="!info.shutdown; else shutdown">
      <div class="row d-flex align-items-stretch">
        <!-- Hash Rate Card -->
        <div class="col-12 col-lg-6 col-xl-3">
          <nb-card class="h-100">
            <nb-card-header>
              <span class="text-hint">{{ 'HOME.HASH_RATE' | translate }}</span>
            </nb-card-header>
            <nb-card-body>
              <div class="d-flex justify-content-between align-items-center mb-3">
                <div>
                  <div class="font-weight-bold text-lg">
                    {{ info.hashRate | number: '1.2-2' }}
                    <small>{{ 'UNITS.HASHRATE' | translate }}</small>
                  </div>
                </div>
                <div class="d-flex align-items-center justify-content-center bg-orange-100 rounded-circle"
                  style="width: 2.5rem; height: 2.5rem;">
                  <nb-icon icon="flash-outline" pack="eva" class="orange-500"></nb-icon>
                </div>
              </div>
              <ng-container *ngIf="expectedHashRate$ | async as expectedHashRate">
                <span class="text-success">{{ expectedHashRate }} <small>{{ 'UNITS.HASHRATE' | translate
                    }}</small></span>
                <span class="text-hint">&nbsp;{{ 'HOME.EXPECTED' | translate }}</span>
              </ng-container>
            </nb-card-body>
          </nb-card>
        </div>

        <!-- Shares Card -->
        <!-- Shares Card -->
        <div class="col-12 col-lg-6 col-xl-3 ps-lg-1">
          <nb-card class="h-100">
            <nb-card-header style="position: relative;">
              <div class="d-flex justify-content-between align-items-center">
                <span class="text-hint">{{ 'HOME.SHARES' | translate }}</span>
                <nb-badge [text]="poolBadgeLabel()" [status]="poolBadgeStatus()" size="small" position="top end"
                  style="margin-top:5px;">
                </nb-badge>
              </div>
            </nb-card-header>

            <nb-card-body>
              <div class="d-flex justify-content-between align-items-center mb-3">
                <div>
                  <div class="font-weight-bold text-lg">{{ info.sharesAccepted }}</div>
                </div>
                <div class="d-flex align-items-center justify-content-center bg-blue-100 rounded-circle"
                  style="width: 2.5rem; height: 2.5rem;">
                  <nb-icon icon="navigation-2-outline" pack="eva" class="blue-500"></nb-icon>
                </div>
              </div>
              <span class="text-danger">{{ info.sharesRejected }}</span>
              <span class="text-hint">&nbsp;{{ 'HOME.REJECTED' | translate }}</span>&nbsp;
              <span class="text-hint">
                ({{ (info.sharesRejected / (info.sharesAccepted + info.sharesRejected) * 100) | number: '1.2-2' }}%)
              </span>
            </nb-card-body>
          </nb-card>
        </div>


        <!-- Efficiency Card -->
        <div class="col-12 col-lg-6 col-xl-3 ps-lg-1">
          <nb-card class="h-100">
            <nb-card-header>
              <span class="text-hint">{{ 'HOME.EFFICIENCY' | translate }}</span>
            </nb-card-header>
            <nb-card-body>
              <div class="d-flex justify-content-between align-items-center mb-3">
                <div>
                  <div class="font-weight-bold text-lg">
                    {{ info.power / (info.hashRate / 1000) | number: '1.2-2' }}
                    <small>J/Th</small>
                  </div>
                </div>
                <div class="d-flex align-items-center justify-content-center bg-orange-100 rounded-circle"
                  style="width: 2.5rem; height: 2.5rem;">
                  <nb-icon icon="checkmark-outline" pack="eva" class="orange-500"></nb-icon>
                </div>
              </div>
            </nb-card-body>
          </nb-card>
        </div>

        <!-- Best Difficulty Card -->
        <div class="col-12 col-lg-6 col-xl-3 ps-lg-1">
          <nb-card class="h-100">
            <nb-card-header>
              <span class="text-hint">{{ 'HOME.BEST_DIFF' | translate }}</span>
            </nb-card-header>
            <nb-card-body>
              <div class="d-flex justify-content-between align-items-center mb-3">
                <div>
                  <div class="font-weight-bold text-lg">
                    {{ info.bestDiff }}
                    <small class="text-hint">{{ 'HOME.BEST_DIFF_ALLTIME' | translate }}</small>
                  </div>
                </div>
                <div class="d-flex align-items-center justify-content-center bg-orange-100 rounded-circle"
                  style="width: 2.5rem; height: 2.5rem;">
                  <nb-icon icon="star" pack="eva" class="orange-500"></nb-icon>
                </div>
              </div>
              <span class="font-weight-bold">{{ info.bestSessionDiff }}</span>
              <span class="text-hint">&nbsp;{{ 'HOME.BEST_DIFF_BOOT' | translate }}</span>
            </nb-card-body>
          </nb-card>
        </div>
      </div>

      <!-- Chart Section -->
      <div class="row mt-3">
        <div class="col-12">
          <nb-card>
            <nb-card-header>
              <span class="text-hint">{{ 'HOME.HASH_RATE_CHART' | translate }}</span>
            </nb-card-header>
            <nb-card-body>
              <canvas #myChart width="400" height="400"></canvas>
            </nb-card-body>
          </nb-card>
        </div>
      </div>

      <div class="row d-flex align-items-stretch">
        <!-- Power Section -->
        <div class="col-12 col-lg-4">
          <nb-card class="h-100">
            <nb-card-header>
              <span class="text-hint">{{ 'PERFORMANCE.POWER' | translate }}</span>
            </nb-card-header>
            <nb-card-body class="no-scroll">
              <div class="row text-center">
                <div class="col-4">
                  <app-gauge [value]="info.power" [min]="info.minPower" [max]="info.maxPower" [unit]="'W'"
                    [label]="'PERFORMANCE.POWER' | translate" [format]="'1.1-1'"></app-gauge>
                </div>
                <div class="col-4">
                  <app-gauge [value]="info.voltage" [format]="'1.1-1'" [min]="info.minVoltage" [max]="info.maxVoltage"
                    [unit]="'V'" [label]="'PERFORMANCE.INPUT_VOLTAGE' | translate"></app-gauge>
                </div>
                <div class="col-4">
                  <app-gauge [value]="info.coreVoltage" [min]="0.9" [max]="1.8" [unit]="'V'"
                    [label]="'PERFORMANCE.ASIC_VOLTAGE' | translate"></app-gauge>
                </div>
              </div>
            </nb-card-body>
          </nb-card>
        </div>

        <!-- Heat Section -->
        <div class="col-12 col-lg-4 px-lg-1">
          <nb-card class="h-100">
            <nb-card-header>
              <span class="text-hint">{{ 'PERFORMANCE.HEAT' | translate }}</span>
            </nb-card-header>
            <nb-card-body class="no-scroll">
              @let heatSectionColModifier = info.vrTemp > 0 ? 6 : 4;

              <div class="row text-center">
                <div class="col-{{ heatSectionColModifier }}" [class.cursor-pointer]="hasChipTemps"
                  [attr.role]="hasChipTemps ? 'button' : null" [attr.tabindex]="hasChipTemps ? '0' : null"
                  [attr.aria-pressed]="hasChipTemps ? (viewMode === 'bars') : null"
                  [attr.title]="hasChipTemps ? (viewMode === 'bars' ? 'Switch to gauge' : 'Switch to chip bars') : null"
                  (click)="onTempViewClick($event)" (keydown.enter)="onTempViewClick($event)"
                  (keydown.space)="onTempViewClick($event)">
                  <!-- Show gauge if feature not available OR user selected gauge -->
                  <ng-container *ngIf="!hasChipTemps || viewMode === 'gauge'; else qxBars">
                    <app-gauge [value]="info.temp" [min]="20" [max]="info?.overheat_temp" [format]="'1.1-1'"
                      [unit]="'°C'" [label]="'PERFORMANCE.ASIC_TEMP' | translate">
                    </app-gauge>
                  </ng-container>

                  <!-- qx multi-bars -->
                  <ng-template #qxBars>
                    <app-asic-temp-bars [temps]="info?.asicTemps ?? [0,0,0,0]" [min]="20"
                      [max]="info?.overheat_temp ?? 70" unit="°C" [warn]="(info?.overheat_temp ?? 70) - 5"
                      [crit]="(info?.overheat_temp ?? 70) - 3" [width]="140" [height]="120">
                    </app-asic-temp-bars>
                  </ng-template>

                </div>
                <div class="col-6" *ngIf="info.vrTemp > 0">
                  <app-gauge [value]="info.vrTemp" [min]="20" [max]="145" [format]="'1.1-1'" [unit]="'°C'"
                    [label]="'PERFORMANCE.VR_TEMP' | translate"></app-gauge>
                </div>
                <div class="col-{{ heatSectionColModifier }}">
                  <app-gauge [value]="info.fanspeed" [min]="0" [format]="'1.0-0'" [max]="100" [unit]="'%'"
                    [label]="'HOME.FAN_SPEED' | translate"></app-gauge>
                </div>
                <div class="col-{{ heatSectionColModifier }}">
                  <app-gauge [value]="info.fanrpm" [format]="'1.0-0'" [min]="0" [max]="20000" [unit]="'RPM'"
                    [label]="'PERFORMANCE.FAN_RPM' | translate"></app-gauge>
                </div>
              </div>
            </nb-card-body>
          </nb-card>
        </div>

        <!-- Performance Section -->
        <div class="col-12 col-lg-4">
          <nb-card class="h-100">
            <nb-card-header>
              <span class="text-hint">{{ 'PERFORMANCE.TITLE' | translate }}</span>
            </nb-card-header>
            <nb-card-body class="no-scroll">
              <div class="row text-center">
                <div class="col-6">
                  <app-gauge [value]="info.frequency" [format]="'1.0-0'" [min]="200" [max]="1000" [unit]="'MHz'"
                    [label]="'PERFORMANCE.ASIC_FREQUENCY' | translate"></app-gauge>
                </div>
                <div class="col-6">
                  <app-gauge [value]="info.coreVoltageActual" [min]="0.9" [max]="1.8" [unit]="'V'"
                    [label]="'PERFORMANCE.ASIC_VOLTAGE_MEASURED' | translate"></app-gauge>
                </div>
              </div>
            </nb-card-body>
          </nb-card>
        </div>
      </div>


      <!-- Pool Information & Uptime Row -->
      <!-- Pool Information Row -->
      <div class="row mt-3 d-flex align-items-stretch">
        <!-- Pool Information Card -->
        <div class="col-12 col-lg-6">
          <!-- Connected? -->
          <ng-container *ngIf="info.isStratumConnected; else disconnected">
            <nb-card class="h-100">
              <nb-card-header>
                <span class="text-hint">
                  {{ 'POOL_INFO.TITLE' | translate }} ({{ info.isUsingFallbackStratum ? ('POOL_INFO.FALLBACK' |
                  translate) : ('POOL_INFO.PRIMARY' | translate) }})
                </span>
              </nb-card-header>

              <nb-card-body class="no-scroll">
                <div class="row flex-nowrap">
                  <div class="col-fixed-width">
                    <span class="text-hint">{{ 'POOL_INFO.HOST' | translate }}:</span>
                  </div>
                  <div class="col break-all">
                    <a [href]="info.isUsingFallbackStratum ? (fallbackQuickLink$ | async) || info.fallbackStratumURL : (quickLink$ | async)"
                      target="_blank">
                      {{ info.isUsingFallbackStratum ? info.fallbackStratumURL : info.stratumURL }}
                    </a>
                  </div>
                </div>

                <div class="row flex-nowrap">
                  <div class="col-fixed-width">
                    <span class="text-hint">{{ 'POOL_INFO.PORT' | translate }}:</span>
                  </div>
                  <div class="col">
                    {{ info.isUsingFallbackStratum ? info.fallbackStratumPort : info.stratumPort }}
                  </div>
                </div>
                <div class="row flex-nowrap">
                  <div class="col-fixed-width">
                    <span class="text-hint">{{ 'POOL_INFO.USER' | translate }}:</span>
                  </div>
                  <div class="col">
                    @let currentStratumUser = info.isUsingFallbackStratum ? info.fallbackStratumUser : info.stratumUser;
                    @let currentStratumUserLength = currentStratumUser.length;

                    <div class="ellipsis-magic" [title]="currentStratumUser">
                      <span class="start">
                        {{ currentStratumUser.substring(0, currentStratumUserLength - 20) }}
                      </span>
                      <span class="end">
                        {{ currentStratumUser.substring(currentStratumUserLength - 20) }}
                      </span>
                    </div>
                  </div>
                </div>
                <div class="row flex-nowrap">
                  <div class="col-fixed-width">
                    <span class="text-hint">{{ 'POOL_INFO.PING' | translate }}:</span>
                  </div>
                  <div class="col">
                    {{ info.lastpingrtt !== undefined ? info.lastpingrtt.toFixed(2) + ' ' + ('PERFORMANCE.MS' |
                    translate) + ' (' + ('PERFORMANCE.AVG' | translate) + ')' : 'n/a' }}
                  </div>
                </div>

                <div class="row flex-nowrap">
                  <div class="col-fixed-width">
                    <span class="text-hint">{{ 'POOL_INFO.LOSS' | translate }}:</span>
                  </div>
                  <div class="col">
                    {{ info.recentpingloss !== undefined ? (info.recentpingloss * 100).toFixed(2) + ' %' : 'n/a' }}
                  </div>
                </div>
                <div class="row flex-nowrap">
                  <div class="col-fixed-width">
                    <span class="text-hint">{{ 'POOL_INFO.DIFF' | translate }}:</span>
                  </div>
                  <div class="col">
                    {{ info.poolDifficulty }}
                  </div>
                </div>
              </nb-card-body>
            </nb-card>
          </ng-container>

          <!-- Disconnected -->
          <ng-template #disconnected>
            <nb-card class="h-100">
              <nb-card-header>
                <span class="text-hint">{{ 'POOL_INFO.TITLE' | translate }}</span>
              </nb-card-header>
              <nb-card-body>
                <nb-alert status="danger" size="small" class="mb-0">
                  Stratum not connected. Pool info unavailable.
                </nb-alert>
              </nb-card-body>
            </nb-card>
          </ng-template>
        </div>
      </div>
    </div>
  </div>