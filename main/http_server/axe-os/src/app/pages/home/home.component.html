<ng-template #loading>
  <h4>{{ 'COMMON.LOADING' | translate }}</h4>
</ng-template>

<ng-template #shutdown>
  <h4>{{ 'COMMON.SHUTDOWN' | translate }}</h4>
</ng-template>

<div>
  <div *ngIf="info$ | async as info; else loading">
    <div *ngIf="!info.shutdown; else shutdown">
      <div class="row d-flex align-items-stretch">
        <!-- Hash Rate Card -->
        <div class="col-12 col-lg-6 col-xl-3">
          <nb-card class="h-100">
            <nb-card-header>
              <span class="text-hint">{{ 'HOME.HASH_RATE' | translate }}</span>
            </nb-card-header>
            <nb-card-body>
              <div class="d-flex justify-content-between align-items-center mb-3">
                <div>
                  <div *ngIf="!isDualPool" class="font-weight-bold text-lg">
                    {{ info.hashRate | number: '1.2-2' }}
                    <small>{{ 'UNITS.HASHRATE' | translate }}</small>
                  </div>
                  <div *ngIf="isDualPool" class="font-weight-bold text-lg">
                    {{ getPoolHashrate(0) | number: '1.2-2' }}
                    <small>{{ 'UNITS.HASHRATE' | translate }}</small>&nbsp;/&nbsp;
                    {{ getPoolHashrate(1) | number: '1.2-2' }}
                    <small>{{ 'UNITS.HASHRATE' | translate }}</small>
                  </div>
                </div>
                <div class="d-flex align-items-center justify-content-center bg-orange-100 rounded-circle"
                  style="width: 2.5rem; height: 2.5rem;">
                  <nb-icon icon="flash-outline" pack="eva" class="orange-500"></nb-icon>
                </div>
              </div>
              <ng-container *ngIf="expectedHashRate$ | async as expectedHashRate">
                <span class="text-success">{{ expectedHashRate }} <small>{{ 'UNITS.HASHRATE' | translate
                    }}</small></span>
                <span class="text-hint">&nbsp;{{ 'HOME.EXPECTED' | translate }}</span>
              </ng-container>
            </nb-card-body>
          </nb-card>
        </div>

        <!-- Shares Card -->
        <!-- Shares Card -->
        <div class="col-12 col-lg-6 col-xl-3 ps-lg-1">
          <nb-card class="h-100">
            <nb-card-header style="position: relative;">
              <div class="d-flex justify-content-between align-items-center">
                <span class="text-hint">{{ 'HOME.SHARES' | translate }}</span>
                <ng-container *ngIf="!isDualPool">
                  <nb-badge class="badge-no-select" [text]="poolBadgeLabel()" [status]="poolBadgeStatus()" size="small"
                    position="top end" style="margin-top:5px;">
                  </nb-badge>
                </ng-container>
                <ng-container *ngIf="isDualPool">
                  <div class="pool-badges">
                    <nb-badge *ngIf="showPoolBadge(0)" class="badge-no-select" [text]="dualPoolBadgeLabel(0)"
                      [status]="dualPoolBadgeStatus(0)" size="small" position="top end"
                      style="width:80px; margin-top:5px; margin-right: 90px;" [nbTooltip]="dualPoolBadgeTooltip(0)">
                    </nb-badge>
                    <nb-badge *ngIf="showPoolBadge(1)" class="badge-no-select" [text]="dualPoolBadgeLabel(1)"
                      [status]="dualPoolBadgeStatus(1)" size="small" position="top end"
                      style="width:80px; margin-top:5px;" [nbTooltip]="dualPoolBadgeTooltip(1)">
                    </nb-badge>
                  </div>
                </ng-container>

              </div>
            </nb-card-header>

            <nb-card-body>
              <div class="d-flex justify-content-between align-items-center mb-3">
                <div>
                  <div *ngIf="!isDualPool">
                    <div class="font-weight-bold text-lg">{{ info.stratum?.pools[0].accepted }}</div>
                  </div>
                  <div *ngIf="isDualPool">
                    <div class="font-weight-bold text-lg">{{ info.stratum?.pools[0].accepted }}&nbsp;/&nbsp;{{
                      info.stratum?.pools[1].accepted }}</div>
                  </div>
                </div>
                <div class="d-flex align-items-center justify-content-center bg-blue-100 rounded-circle"
                  style="width: 2.5rem; height: 2.5rem;">
                  <nb-icon icon="navigation-2-outline" pack="eva" class="blue-500"></nb-icon>
                </div>
              </div>
              <span *ngIf="!isDualPool" class="text-danger">{{ info.stratum?.pools[0].rejected
                }}</span>
              <span *ngIf="isDualPool" class="text-danger">{{ info.stratum?.pools[0].rejected
                }}&nbsp;/&nbsp;{{ info.stratum?.pools[1].rejected }}</span>
              <span class="text-hint">&nbsp;{{ 'HOME.REJECTED' | translate }}</span>&nbsp;
              <span *ngIf="!isDualPool" class="text-hint">
                ({{ rejectRate(0) | number: '1.2-2' }}%)
              </span>
              <span *ngIf="isDualPool" class="text-hint">
                ({{ rejectRate(0) | number: '1.2-2' }}%&nbsp;/&nbsp;{{ rejectRate(1) | number: '1.2-2' }}%)
              </span>
            </nb-card-body>
          </nb-card>
        </div>


        <!-- Efficiency Card -->
        <div class="col-12 col-lg-6 col-xl-3 ps-lg-1">
          <nb-card class="h-100">
            <nb-card-header>
              <span class="text-hint">{{ 'HOME.EFFICIENCY' | translate }}</span>
            </nb-card-header>
            <nb-card-body>
              <div class="d-flex justify-content-between align-items-center mb-3">
                <div>
                  <div class="font-weight-bold text-lg">
                    {{ info.power / (info.hashRate / 1000) | number: '1.2-2' }}
                    <small>J/Th</small>
                  </div>
                </div>
                <div class="d-flex align-items-center justify-content-center bg-orange-100 rounded-circle"
                  style="width: 2.5rem; height: 2.5rem;">
                  <nb-icon icon="checkmark-outline" pack="eva" class="orange-500"></nb-icon>
                </div>
              </div>
            </nb-card-body>
          </nb-card>
        </div>

        <!-- Best Difficulty Card -->
        <div class="col-12 col-lg-6 col-xl-3 ps-lg-1">
          <nb-card class="h-100">
            <nb-card-header>
              <span class="text-hint">{{ 'HOME.BEST_DIFF' | translate }}</span>
            </nb-card-header>
            <nb-card-body>
              <div class="d-flex justify-content-between align-items-center mb-3">
                <div>
                  <div class="font-weight-bold text-lg">
                    {{ info.bestDiff }}
                    <small class="text-hint">{{ 'HOME.BEST_DIFF_ALLTIME' | translate }}</small>
                  </div>
                </div>
                <div class="d-flex align-items-center justify-content-center bg-orange-100 rounded-circle"
                  style="width: 2.5rem; height: 2.5rem;">
                  <nb-icon icon="star" pack="eva" class="orange-500"></nb-icon>
                </div>
              </div>
              <span *ngIf="!isDualPool" class="font-weight-bold">{{ info.stratum?.pools[0].bestDiff
                |
                humanReadable}}</span>
              <span *ngIf="isDualPool" class="font-weight-bold">{{ info.stratum?.pools[0].bestDiff
                |
                humanReadable}}&nbsp;/&nbsp;{{ info.stratum?.pools[1].bestDiff | humanReadable}}</span>
              <span class="text-hint">&nbsp;{{ 'HOME.BEST_DIFF_BOOT' | translate }}</span>
            </nb-card-body>
          </nb-card>
        </div>
      </div>

      <!-- Chart Section -->
      <div class="row mt-3">
        <div class="col-12">
          <nb-card>
            <nb-card-header>
              <span class="text-hint">{{ 'HOME.HASH_RATE_CHART' | translate }}</span>
            </nb-card-header>
            <nb-card-body>
              <canvas #myChart width="400" height="400"></canvas>
            </nb-card-body>
          </nb-card>
        </div>
      </div>

      <div class="row d-flex align-items-stretch">
        <!-- Power Section -->
        <div class="col-12 col-lg-4">
          <nb-card class="h-100">
            <nb-card-header>
              <span class="text-hint">{{ 'PERFORMANCE.POWER' | translate }}</span>
            </nb-card-header>
            <nb-card-body class="no-scroll">
              <div class="row text-center">
                <div class="col-4">
                  <app-gauge [value]="info.power" [min]="info.minPower" [max]="info.maxPower" [unit]="'W'"
                    [label]="'PERFORMANCE.POWER' | translate" [format]="'1.1-1'"></app-gauge>
                </div>
                <div class="col-4">
                  <app-gauge [value]="info.voltage" [format]="'1.1-1'" [min]="info.minVoltage" [max]="info.maxVoltage"
                    [unit]="'V'" [label]="'PERFORMANCE.INPUT_VOLTAGE' | translate"></app-gauge>
                </div>
                <div class="col-4">
                  <app-gauge [value]="info.coreVoltage" [min]="0.9" [max]="1.8" [unit]="'V'"
                    [label]="'PERFORMANCE.ASIC_VOLTAGE' | translate"></app-gauge>
                </div>
              </div>
            </nb-card-body>
          </nb-card>
        </div>

        <!-- Heat Section -->
        <div class="col-12 col-lg-4 px-lg-1">
          <nb-card class="h-100">
            <nb-card-header>
              <span class="text-hint">{{ 'PERFORMANCE.HEAT' | translate }}</span>
            </nb-card-header>
            <nb-card-body class="no-scroll">
              @let heatSectionColModifier = info.vrTemp > 0 ? 6 : 4;

              <div class="row text-center">
                <div class="col-{{ heatSectionColModifier }}" [class.cursor-pointer]="hasChipTemps"
                  [attr.role]="hasChipTemps ? 'button' : null" [attr.tabindex]="hasChipTemps ? '0' : null"
                  [attr.aria-pressed]="hasChipTemps ? (viewMode === 'bars') : null"
                  [attr.title]="hasChipTemps ? (viewMode === 'bars' ? 'Switch to gauge' : 'Switch to chip bars') : null"
                  (click)="onTempViewClick($event)" (keydown.enter)="onTempViewClick($event)"
                  (keydown.space)="onTempViewClick($event)">
                  <!-- Show gauge if feature not available OR user selected gauge -->
                  <ng-container *ngIf="!hasChipTemps || viewMode === 'gauge'; else qxBars">
                    <app-gauge [value]="info.temp" [min]="20" [max]="info?.overheat_temp" [format]="'1.1-1'"
                      [unit]="'°C'" [label]="'PERFORMANCE.ASIC_TEMP' | translate">
                    </app-gauge>
                  </ng-container>

                  <!-- qx multi-bars -->
                  <ng-template #qxBars>
                    <app-asic-temp-bars [temps]="info?.asicTemps ?? [0,0,0,0]" [min]="20"
                      [max]="info?.overheat_temp ?? 70" unit="°C" [warn]="(info?.overheat_temp ?? 70) - 5"
                      [crit]="(info?.overheat_temp ?? 70) - 3" [width]="140" [height]="120">
                    </app-asic-temp-bars>
                  </ng-template>

                </div>
                <div class="col-6" *ngIf="info.vrTemp > 0">
                  <app-gauge [value]="info.vrTemp" [min]="20" [max]="145" [format]="'1.1-1'" [unit]="'°C'"
                    [label]="'PERFORMANCE.VR_TEMP' | translate"></app-gauge>
                </div>
                <div class="col-{{ heatSectionColModifier }}">
                  <app-gauge [value]="info.fanspeed" [min]="0" [format]="'1.0-0'" [max]="100" [unit]="'%'"
                    [label]="'HOME.FAN_SPEED' | translate"></app-gauge>
                </div>
                <div class="col-{{ heatSectionColModifier }}">
                  <app-gauge [value]="info.fanrpm" [format]="'1.0-0'" [min]="0" [max]="20000" [unit]="'RPM'"
                    [label]="'PERFORMANCE.FAN_RPM' | translate"></app-gauge>
                </div>
              </div>
            </nb-card-body>
          </nb-card>
        </div>

        <!-- Performance Section -->
        <div class="col-12 col-lg-4">
          <nb-card class="h-100">
            <nb-card-header>
              <span class="text-hint">{{ 'PERFORMANCE.TITLE' | translate }}</span>
            </nb-card-header>
            <nb-card-body class="no-scroll">
              <div class="row text-center">
                <div class="col-6">
                  <app-gauge [value]="info.frequency" [format]="'1.0-0'" [min]="200" [max]="1000" [unit]="'MHz'"
                    [label]="'PERFORMANCE.ASIC_FREQUENCY' | translate"></app-gauge>
                </div>
                <div class="col-6">
                  <app-gauge [value]="info.coreVoltageActual" [min]="0.9" [max]="1.8" [unit]="'V'"
                    [label]="'PERFORMANCE.ASIC_VOLTAGE_MEASURED' | translate"></app-gauge>
                </div>
              </div>
            </nb-card-body>
          </nb-card>
        </div>
      </div>


      <!-- Pool Information & Uptime Row -->
      <div class="row mt-3 d-flex align-items-stretch">
        <div class="col-12 col-lg-6" *ngFor="let idx of getPoolCardIndices()">
          @let poolInfo = getPoolInfo(idx);
          @let usingFallback = info.stratum?.usingFallback;

          <nb-card class="h-100">
            <nb-card-header>
              <span *ngIf="!isDualPool" class="text-hint">
                {{ 'POOL_INFO.TITLE' | translate }}
                (
                {{ usingFallback ? ('POOL_INFO.FALLBACK' | translate)
                : ('POOL_INFO.PRIMARY' | translate) }}
                )
              </span>
              <span *ngIf="isDualPool" class="text-hint">
                Pool {{ idx + 1 }}
              </span>
            </nb-card-header>

            <nb-card-body class="no-scroll">
              <!-- Optional: pro Pool "disconnected" anzeigen -->
              <ng-container *ngIf="poolInfo.connected; else poolDisconnected">

                <!-- Host -->
                <div class="row flex-nowrap">
                  <div class="col-fixed-width">
                    <span class="text-hint">{{ 'POOL_INFO.HOST' | translate }}:</span>
                  </div>
                  <div class="col break-all">
                    <a [href]="getQuickLink(poolInfo.host, poolInfo.user)" target="_blank">
                      {{ poolInfo.host }}
                    </a>
                  </div>
                </div>

                <!-- Port -->
                <div class="row flex-nowrap">
                  <div class="col-fixed-width">
                    <span class="text-hint">{{ 'POOL_INFO.PORT' | translate }}:</span>
                  </div>
                  <div class="col">
                    {{ poolInfo.port }}
                  </div>
                </div>

                <!-- User (ellipsis-magic) -->
                <div class="row flex-nowrap">
                  <div class="col-fixed-width">
                    <span class="text-hint">{{ 'POOL_INFO.USER' | translate }}:</span>
                  </div>
                  <div class="col">
                    <div class="ellipsis-magic" [title]="poolInfo.user">
                      <span class="start">
                        {{ poolInfo.user.substring(0, poolInfo.user.length - 20) }}
                      </span>
                      <span class="end">
                        {{ poolInfo.user.substring(poolInfo.user.length - 20) }}
                      </span>
                    </div>
                  </div>
                </div>

                <!-- Ping -->
                <div class="row flex-nowrap">
                  <div class="col-fixed-width">
                    <span class="text-hint">{{ 'POOL_INFO.PING' | translate }}:</span>
                  </div>
                  <div class="col">
                    {{ poolInfo.pingRtt !== undefined && poolInfo.pingRtt !== null
                    ? (poolInfo.pingRtt.toFixed(2) + ' ' + ('PERFORMANCE.MS' | translate)
                    + ' (' + ('PERFORMANCE.AVG' | translate) + ')')
                    : 'n/a' }}
                  </div>
                </div>

                <!-- Loss -->
                <div class="row flex-nowrap">
                  <div class="col-fixed-width">
                    <span class="text-hint">{{ 'POOL_INFO.LOSS' | translate }}:</span>
                  </div>
                  <div class="col">
                    {{ poolInfo.pingLoss !== undefined && poolInfo.pingLoss !== null
                    ? (poolInfo.pingLoss * 100).toFixed(2) + ' %'
                    : 'n/a' }}
                  </div>
                </div>

                <!-- Difficulty -->
                <div class="row flex-nowrap">
                  <div class="col-fixed-width">
                    <span class="text-hint">{{ 'POOL_INFO.DIFF' | translate }}:</span>
                  </div>
                  <div class="col">
                    {{ poolInfo.poolDifficulty ?? 'n/a' }}
                  </div>
                </div>

              </ng-container>

              <!-- Card-Inhalt, falls genau dieser Pool nicht verbunden ist -->
              <ng-template #poolDisconnected>
                <nb-alert status="danger" size="small" class="mb-0">
                  Stratum not connected for this pool.
                </nb-alert>
              </ng-template>
            </nb-card-body>
          </nb-card>
        </div>
      </div>
    </div>
  </div>
</div>