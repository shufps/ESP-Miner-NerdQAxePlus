<ng-container>
  <!-- Manual Addition -->
  <nb-card>
    <nb-card-body>
      <form [formGroup]="form">
        <div class="d-flex align-items-center gap-3">
          <!-- Label container -->
          <label class="manual-add-label">{{ 'UPDATE.MANUAL_ADDITION' | translate }}</label>
          <!-- Input group container -->
          <div class="input-group" style="flex: 1; display: flex; flex-flow: nowrap;">
            <input nbInput id="manualAddIp" formControlName="manualAddIp" type="text"
                   [placeholder]="'UPDATE.ENTER_IP_ADDRESS' | translate" style="flex: 1; width: 100%;" />
            <button nbButton status="primary" (click)="add()" [disabled]="form.invalid">{{ 'UPDATE.ADD' | translate }}</button>
          </div>
        </div>
      </form>
    </nb-card-body>
  </nb-card>

  <form [formGroup]="form">
    <!-- Outer container allows wrapping -->
    <div class="buttons-slider-area">
      <!-- Left group: Buttons -->
      <div class="scan-refresh-buttons">
        <button nbButton status="primary" (click)="scanNetwork()" [disabled]="scanning">
          {{ scanning ? ('UPDATE.SCANNING' | translate) : ('UPDATE.AUTOMATIC_SCAN' | translate) }}
        </button>
        <button nbButton status="info" (click)="refreshList()" [disabled]="scanning || isRefreshing">
          {{ isRefreshing ? ('UPDATE.REFRESHING' | translate) : (('UPDATE.REFRESH_LIST' | translate) + ' (' + refreshIntervalTime + ')') }}
        </button>
      </div>

      <!-- Right group: Label and Slider -->
      <div class="mt-3 mt-md-0 time-slider">
        <label for="refresh-interval">{{ 'UPDATE.REFRESH_INTERVAL' | translate }}:</label>
        <div class="progress-wrap mx-2">
          <input id="refresh-interval" type="range" class="progress" [formControl]="refreshIntervalControl"
                 [min]="5" [max]="30" step="1" />
          <div class="progress-foreground"
               [style.width.%]="((refreshIntervalControl.value - 5) / 25) * 100">
          </div>
        </div>
        <span>{{ refreshTimeSet }}s</span>
      </div>
    </div>
  </form>

  <!-- Totals -->
  <div class="d-flex justify-content-between mt-4 mb-3 gap-md-3 totals">
    <nb-card class="text-center mb-0" style="flex: 1;">
      <nb-card-body>
        <span class="text-start">{{ 'SWARM.TOTAL_HASH_RATE' | translate }}</span>
        <span class="text-primary fw-bold">{{ totals.hashRate * 1000000000 | hashSuffix }}</span>
      </nb-card-body>
    </nb-card>
    <nb-card class="text-center mb-0" style="flex: 1;">
      <nb-card-body>
        <span class="text-start">{{ 'SWARM.TOTAL_POWER' | translate }}</span>
        <span class="text-primary fw-bold">{{ totals.power | number:'1.1-1' }} W</span>
      </nb-card-body>
    </nb-card>
    <nb-card class="text-center mb-0" style="flex: 1;">
      <nb-card-body>
        <span class="text-start">{{ 'SWARM.BEST_DIFF' | translate }}</span>
        <span class="text-primary fw-bold">{{ totals.bestDiff === '0.00' ? 0 : totals.bestDiff }}</span>
      </nb-card-body>
    </nb-card>
  </div>

  <!-- Swarm Overview Table -->
  <nb-card class="mb-0">
    <nb-card-header>{{ 'SWARM.OVERVIEW' | translate }}</nb-card-header>

    <nb-card-body *ngIf="swarm.length; else empty">
      <table class="swarm-table">
        @let dp = hasDualPoolRows();
        <thead>
          <tr>
            <th>{{ 'SWARM.IP_ADDRESS' | translate }}</th>
            <th [colSpan]="dp ? 2 : 1">{{ 'SWARM.HASH_RATE' | translate }}</th>
            <th>{{ 'SWARM.UPTIME' | translate }}</th>
            <th [colSpan]="dp ? 2 : 1">{{ 'SWARM.SHARES' | translate }}</th>
            <th>{{ 'SWARM.POWER' | translate }}</th>
            <th>{{ 'SWARM.TEMP' | translate }}</th>
            <th [colSpan]="dp ? 2 : 1">{{ 'SWARM.POOL_DIFF' | translate }}</th>
            <th [colSpan]="dp ? 2 : 1">{{ 'SWARM.BEST_DIFF' | translate }}</th>
            <th>{{ 'SWARM.VERSION' | translate }}</th>
            <th>&nbsp;</th>
            <th>&nbsp;</th>
            <th>&nbsp;</th>
          </tr>
          <tr *ngIf="dp" class="dual-pool-header">
            <td></td>
            <td>Pool 1</td><td>Pool 2</td>
            <td></td>
            <td>Pool 1</td><td>Pool 2</td>
            <td></td>
            <td></td>
            <td>Pool 1</td><td>Pool 2</td>
            <td>Pool 1</td><td>Pool 2</td>
            <td></td>
            <td>&nbsp;</td>
            <td>&nbsp;</td>
            <td>&nbsp;</td>
          </tr>

        </thead>
        <tbody>
          <ng-container *ngFor="let axe of swarm">
            @let dualPool = isDualPoolEntry(axe);
            @let p0 = axe.stratum?.pools[0];
            @let p1 = axe.stratum?.pools[1];
            <tr class="base-row">
              <!-- IP with swarmColor dot -->

              <td [rowSpan]="dualPool ? 2 : 1">
                <a [href]="'http://' + axe.IP" target="_blank">
                  <span class="swarm-dot" [style.background]="axe.swarmColor || 'blue'"></span>
                  {{ axe.IP }}
                </a>
                <div class="text-sm">{{ axe.hostname }}</div>
              </td>

              <!-- Hash Rate -->
              <td [colSpan]="dp ? 2 : 1">{{ axe.hashRate * 1000000000 | hashSuffix }}</td>

              <!-- Uptime -->
              <td [rowSpan]="dualPool ? 2 : 1">{{ axe.uptimeSeconds | dateAgo: {intervals: 2} }}</td>

              <!-- Shares (Accepted & Rejected) -->
              <td [colSpan]="dp ? 2 : 1">
                <div [nbTooltip]="'UPDATE.SHARES_ACCEPTED' | translate" tooltipPosition="top">
                  {{ axe.sharesAccepted | number:'1.0-0' }}
                </div>
                <div [nbTooltip]="'UPDATE.SHARES_REJECTED' | translate" tooltipPosition="top" class="text-sm">
                  {{ axe.sharesRejected | number:'1.0-0' }}
                </div>
              </td>

              <!-- Power -->
              <td [rowSpan]="dualPool ? 2 : 1">{{ axe.power | number:'1.1-1' }} <small>W</small></td>

              <!-- Temperature (with VR temp if available) -->
              <td [rowSpan]="dualPool ? 2 : 1">
                <div [ngClass]="{'text-orange-500': axe.temp > 68}">
                  {{ axe.temp | number:'1.0-1' }}°<small>C</small>
                </div>
                <div *ngIf="axe.vrTemp"
                     [nbTooltip]="'UPDATE.VOLTAGE_REGULATOR_TEMPERATURE' | translate"
                     tooltipPosition="top"
                     [ngClass]="{'text-orange-500': axe.vrTemp > 90}"
                     class="text-sm">
                  {{ axe.vrTemp | number:'1.0-1' }}°<small>C</small>
                </div>
              </td>

              <!-- Stratum Pool Diff -->
              <td [colSpan]="dp ? 2 : 1">{{ axe.poolDifficulty | number:'1.0-0' }}</td>

              <!-- Best Diff with Best Session Diff tooltip -->
              <td [colSpan]="dp ? 2 : 1">
                <div>{{ axe.bestDiff }}</div>
                <div *ngIf="!dualPool" [nbTooltip]="'UPDATE.BEST_SESSION_DIFF' | translate" tooltipPosition="top" class="text-sm">
                  {{ axe.bestSessionDiff }}
                </div>
                <div *ngIf="dualPool" class="text-sm">&nbsp;</div>
              </td>

              <!-- Version -->
              <td [rowSpan]="dualPool ? 2 : 1">{{ axe.version }}</td>

              <!-- Action Buttons -->
              <td [rowSpan]="dualPool ? 2 : 1">
                <button nbButton status="warning" size="small"
                        (click)="edit(axe)"
                        [nbTooltip]="axe.supportsAsicApi ? ('UPDATE.EDIT_SETTINGS' | translate) : ('UPDATE.FIRMWARE_UPDATE_REQUIRED' | translate)"
                        tooltipPosition="top">
                  <nb-icon icon="edit-outline"></nb-icon>
                </button>
              </td>
              <td [rowSpan]="dualPool ? 2 : 1">
                <button nbButton status="danger" size="small" (click)="restart(axe)"
                  [nbTooltip]="'UPDATE.RESTART_DEVICE' | translate" tooltipPosition="top">
                  <nb-icon icon="sync-outline"></nb-icon>
                </button>
              </td>
              <td [rowSpan]="dualPool ? 2 : 1">
                <button nbButton status="basic" size="small" (click)="remove(axe)"
                [nbTooltip]="'UPDATE.REMOVE_FROM_LIST' | translate" tooltipPosition="top">
                  <nb-icon icon="trash-2-outline"></nb-icon>
                </button>
              </td>
            </tr>
            <tr *ngIf="dualPool" class="dual-pool-2nd-row">
              @let hr = axe.hashRate * 1000000000;
              @let hr1 = hr * axe.stratum.poolBalance / 100;
              @let hr2 = hr * (100 - axe.stratum.poolBalance) / 100;
              <td class="shrink">{{ hr1 | hashSuffix }}</td>
              <td class="shrink">{{ hr2 | hashSuffix }}</td>

              <td class="shrink">{{ p0.accepted }}<br/>{{ p0.rejected }}</td>
              <td class="shrink">{{ p1.accepted }}<br>{{ p1.rejected }}</td>
              <td class="shrink">{{ p0.poolDifficulty }}</td>
              <td class="shrink">{{ p1.poolDifficulty }}</td>
              <td class="shrink">{{ p0.bestDiff | humanReadable }}</td>
              <td class="shrink">{{ p1.bestDiff | humanReadable }}</td>
            </tr>
          </ng-container>
        </tbody>
      </table>

      <!-- Legend -->
      <div class="d-flex flex-wrap gap-3 mt-3 text-sm justify-content-center">
        <ng-container *ngFor="let item of colorLegend">
          <div class="legend-chip" [title]="item.label + ' (' + item.color + ') ×' + item.count">
            <span class="swarm-dot" [style.background]="item.color"></span>
            <span class="legend-label">{{ item.label }}</span>
            <span class="legend-count">×{{ item.count }}</span>
          </div>
        </ng-container>
      </div>

    </nb-card-body>

    <ng-template #empty>
      <div class="p-4 text-center text-secondary">{{ 'SWARM.EMPTY_LIST' | translate }}</div>
    </ng-template>
  </nb-card>

  <!-- Edit Modal -->
  <div *ngIf="showEdit">
    <div class="modal-backdrop" (click)="showEdit = false"></div>
    <nb-card class="modal">
      <nb-card-header>
        <button nbButton status="danger" size="small" (click)="showEdit = false">&#10006;</button>
      </nb-card-header>
      <nb-card-body>
        <h1>{{ selectedAxeOs?.IP }}</h1>
        <app-edit [uri]="'http://' + selectedAxeOs?.IP"></app-edit>
      </nb-card-body>
    </nb-card>
  </div>
</ng-container>
